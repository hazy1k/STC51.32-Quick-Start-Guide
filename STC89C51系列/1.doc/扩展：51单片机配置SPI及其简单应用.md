# 扩展：51单片机配置SPI及其简单应用

## 1. SPI简介

SPI（Serial Peripheral Interface）是一种同步串行通信协议，用于在微控制器和外部设备之间传输数据。SPI使用四根信号线：时钟（SCK）、主设备输出从设备输入（MOSI）、主设备输入从设备输出（MISO）和片选（SS）。数据通过MOSI线发送，接收通过MISO线进行，SCK提供时钟信号来同步数据传输，SS用于选择具体的从设备。SPI支持全双工通信、较高的数据传输速率，并且可以通过多个从设备共享总线。

## 2. SPI协议基本结构

1. **信号线**：
   
   - **SCK（Serial Clock）**：由主设备生成的时钟信号，用于同步数据传输。
   - **MOSI（Master Out Slave In）**：主设备输出，从设备输入线，用于传输数据到从设备。
   - **MISO（Master In Slave Out）**：主设备输入，从设备输出线，用于从设备发送数据到主设备。
   - **SS（Slave Select）**：选择特定的从设备，通常为低电平有效。

2. **工作模式**：
   SPI支持四种工作模式，通过时钟极性（CPOL）和时钟相位（CPHA）设置。模式定义如下：
   
   - **模式0**：CPOL = 0，CPHA = 0
   - **模式1**：CPOL = 0，CPHA = 1
   - **模式2**：CPOL = 1，CPHA = 0
   - **模式3**：CPOL = 1，CPHA = 1
   
   这些模式决定了数据的传输时序，即数据何时被采样和更改。

3. **数据传输**：
   
   - **全双工通信**：数据可以在主设备和从设备之间同时发送和接收。
   - **字节传输**：数据通常以字节为单位进行传输。

4. **通信流程**：
   
   - **选择从设备**：主设备通过将SS线拉低来选择要通信的从设备。
   - **数据传输**：
     1. 主设备在MOSI线上发送数据。
     2. 从设备在MISO线上接收数据。
     3. 主设备和从设备通过SCK同步数据传输。
   - **结束通信**：主设备通过将SS线拉高来取消选择从设备。

5. **数据速率**：
   
   - SPI的传输速率通常较高，但受到主设备和从设备的能力限制。时钟频率可以从几千赫兹到数十兆赫兹不等。

6. **主设备和从设备**：
   
   - **主设备**：控制通信过程，生成时钟信号。
   - **从设备**：响应主设备的命令，接收或发送数据。

## 3. 配置SPI总线

### 1. 硬件SPI（如果单片机支持）

许多51系列单片机（如某些型号的Atmel AT89系列）配备了硬件SPI模块，这使得配置和使用SPI更为简单。下面的步骤是基于硬件SPI的配置：

1. **设置SPI工作模式**：
   
   - 确定SPI的工作模式（如时钟极性、时钟相位和数据传输顺序），根据SPI设备的要求配置SPI寄存器。

2. **选择主设备/从设备模式**：
   
   - 设置SPI为主设备或从设备。

3. **配置时钟频率**：
   
   - 根据需要设置SPI时钟频率。

### 2. 软件SPI（如果单片机没有硬件SPI模块）

如果51单片机没有硬件SPI模块，你可以通过软件实现SPI通信。以下是一个简单的软件SPI实现：

1. 定义SPI引脚

```c
#define SCK P1_0 // SPI时钟线
#define MOSI P1_1 // 主设备输出，从设备输入
#define MISO P1_2 // 主设备输入，从设备输出
#define SS P1_3   // 片选线
```

2. 初始化SPI接口

```c
void SPI_Init() {
    SCK = 0;   // 初始化SCK为低
    MOSI = 0;  // 初始化MOSI为低
    SS = 1;    // 片选线为高
}
```

3. 发送字节数据

```c
void SPI_SendByte(unsigned char data) {
    unsigned char i;
    for (i = 0; i < 8; i++) {
        if (data & 0x80) {
            MOSI = 1; // 发送1
        } else {
            MOSI = 0; // 发送0
        }
        SCK = 1; // 产生时钟信号
        SCK = 0; // 结束时钟信号
        data <<= 1; // 处理下一个数据位
    }
}

```

4. 接收字节数据

```c
unsigned char SPI_ReceiveByte() {
    unsigned char i, data = 0;
    for (i = 0; i < 8; i++) {
        SCK = 1; // 产生时钟信号
        data <<= 1;
        if (MISO) {
            data |= 0x01; // 读取MISO数据
        }
        SCK = 0; // 结束时钟信号
    }
    return data;
}

```

5. 发送和接收字节数据的例子

```c
void SPI_TransmitReceive(unsigned char sendData, unsigned char *receiveData) {
    SPI_SendByte(sendData);  // 发送数据
    *receiveData = SPI_ReceiveByte(); // 接收数据
}

```

## 4. 简单应用实例

假设你有一个SPI温度传感器，它需要通过SPI接口读取温度数据。以下是一个简单的SPI应用示例：

```c
void ReadTemperatureSensor() {
    unsigned char sendData = 0x00;  // 发送命令读取温度
    unsigned char receivedData;
    
    SPI_Init(); // 初始化SPI
    SS = 0;     // 选择SPI设备
    SPI_TransmitReceive(sendData, &receivedData); // 发送命令并接收数据
    SS = 1;     // 取消选择SPI设备

    // 处理接收到的温度数据
    // 例如，可以将receivedData转换为实际温度值并显示或处理
}
```

说明：

- **SPI_Init**：初始化SPI引脚。
- **SPI_SendByte**：通过SPI发送一个字节的数据。
- **SPI_ReceiveByte**：通过SPI接收一个字节的数据。
- **SPI_TransmitReceive**：发送和接收一个字节数据。
- **ReadTemperatureSensor**：读取温度传感器的数据并处理。

## 5. I2C与SPI之比较

### I2C（Inter-Integrated Circuit）

#### 1. **基本特点**

- **信号线**：使用两根信号线——SDA（数据线）和SCL（时钟线）。
- **设备地址**：支持多达127个从设备（通过地址选择）。
- **双向通信**：数据线支持双向通信。
- **通信模式**：单主机模式和多主机模式。

#### 2. **优点**

- **线缆简洁**：只需要两根信号线（SDA和SCL），简化了布线。
- **支持多设备**：通过地址选择支持多个从设备，适合设备数量多的应用。
- **简化的硬件**：相对于SPI，I2C需要的硬件和连接更少。

#### 3. **缺点**

- **数据速率较低**：标准速率通常为100kHz或400kHz，高速模式可以达到1MHz。
- **较高的总线负载**：由于所有设备共享同一条数据总线，负载增加可能会影响通信稳定性。
- **协议复杂**：需要管理设备地址和数据冲突，协议相对复杂。

#### 4. **应用场景**

- 适用于短距离通信，如主板上的传感器、EEPROM、时钟芯片等。
- 多设备环境中，如多个传感器与微控制器通信。

### SPI（Serial Peripheral Interface）

#### 1. **基本特点**

- **信号线**：使用四根信号线——SCK（时钟线）、MOSI（主设备输出从设备输入）、MISO（主设备输入从设备输出）、SS（从设备选择）。
- **设备地址**：通过选择线（SS）进行设备选择，通常每个从设备有单独的SS线。
- **全双工通信**：数据可以同时在主设备和从设备之间发送和接收。

#### 2. **优点**

- **数据速率高**：支持高速数据传输，时钟频率通常可以达到数十MHz。
- **全双工通信**：支持同时发送和接收数据，提高了通信效率。
- **简单协议**：协议本身较为简单，不需要处理设备地址和数据冲突。

#### 3. **缺点**

- **线缆多**：需要多根信号线，特别是在多个从设备的情况下，需要额外的SS线。
- **设备数量受限**：虽然可以连接多个从设备，但每个从设备需要一个独立的SS线，可能限制了从设备的数量。
- **协议缺乏错误检测**：SPI协议本身没有内置错误检测机制，需要额外的错误处理机制。

#### 4. **应用场景**

- 适用于高速数据传输的应用，如闪存、显示屏、传感器。
- 单一主设备与多个从设备通信，尤其是在速度要求较高的场景中。

### 总结

- **I2C**：适合需要简单布线和多设备环境的应用，但在数据速率和协议复杂性方面有所限制。
- **SPI**：适合需要高数据速率和全双工通信的应用，但在引脚数量和从设备数量上可能受限。
